from __future__ import annotations

import argparse
from pathlib import Path

from rb.env import load_dotenv
from rb.congress_control import ensure_congress_control
from rb.ingest import ingest_from_spec
from rb.metrics import compute_term_metrics
from rb.presidents import ensure_presidents
from rb.regimes import ensure_regime_pipeline

PRESIDENT_SOURCES = ("congress_legislators", "wikidata")
PRESIDENT_GRANULARITY = ("tenure", "term")


def _parse_args() -> argparse.Namespace:
    p = argparse.ArgumentParser(prog="rb", description="Reproducible D-vs-R performance pipeline tooling.")
    sub = p.add_subparsers(dest="cmd", required=True)

    ingest = sub.add_parser("ingest", help="Fetch and cache raw data + write normalized derived tables.")
    ingest.add_argument("--spec", type=Path, default=Path("spec/metrics_v1.yaml"), help="Metric registry spec YAML.")
    ingest.add_argument("--refresh", action="store_true", help="Re-download and write a new raw artifact version.")
    ingest.add_argument(
        "--sources",
        action="append",
        default=[],
        help="Restrict ingestion to these spec source names (repeatable), e.g. --sources fred --sources stooq.",
    )
    ingest.add_argument(
        "--series",
        action="append",
        default=[],
        help="Restrict ingestion to these series keys from the spec (repeatable).",
    )
    ingest.add_argument("--dotenv", type=Path, default=Path(".env"), help="Optional .env file to load into env vars.")

    presidents = sub.add_parser("presidents", help="Fetch and cache presidential terms + party labels.")
    presidents.add_argument("--refresh", action="store_true", help="Re-download and write a new raw artifact version.")
    presidents.add_argument(
        "--source",
        choices=PRESIDENT_SOURCES,
        default="congress_legislators",
        help="Source of presidential terms/party labels.",
    )
    presidents.add_argument(
        "--output",
        type=Path,
        default=Path("data/derived/presidents.csv"),
        help="Output CSV for presidential windows.",
    )
    presidents.add_argument(
        "--granularity",
        choices=PRESIDENT_GRANULARITY,
        default="tenure",
        help="Emit per-president tenure windows (tenure) or constitutional terms (term).",
    )
    presidents.add_argument("--dotenv", type=Path, default=Path(".env"), help="Optional .env file to load into env vars.")

    congress = sub.add_parser("congress", help="Fetch and derive House/Senate party control by Congress session.")
    congress.add_argument("--refresh", action="store_true", help="Re-download and write a new raw artifact version.")
    congress.add_argument(
        "--output",
        type=Path,
        default=Path("data/derived/congress_control/congress_control.csv"),
        help="Output CSV for Congress party control.",
    )
    congress.add_argument("--dotenv", type=Path, default=Path(".env"), help="Optional .env file to load into env vars.")

    regimes = sub.add_parser("regimes", help="Compute metric tables over (President x Congress) regime windows.")
    regimes.add_argument("--refresh", action="store_true", help="Re-download upstream artifacts when possible.")
    regimes.add_argument("--spec", type=Path, default=Path("spec/metrics_v1.yaml"), help="Metric registry spec YAML.")
    regimes.add_argument("--attribution", type=Path, default=Path("spec/attribution_v1.yaml"), help="Attribution spec YAML.")
    regimes.add_argument("--presidents", type=Path, default=Path("data/derived/presidents.csv"), help="Presidents windows CSV.")
    regimes.add_argument(
        "--president-source",
        choices=PRESIDENT_SOURCES,
        default="congress_legislators",
        help="If --presidents does not exist, generate it from this source.",
    )
    regimes.add_argument(
        "--president-granularity",
        choices=PRESIDENT_GRANULARITY,
        default="tenure",
        help="If generating --presidents, choose tenure vs term windows.",
    )
    regimes.add_argument(
        "--congress-control",
        type=Path,
        default=Path("data/derived/congress_control/congress_control.csv"),
        help="Congress control CSV (generated by `rb congress`).",
    )
    regimes.add_argument(
        "--output-windows-labels",
        type=Path,
        default=Path("data/derived/regimes/regime_windows_labels.csv"),
        help="Output CSV describing regime windows.",
    )
    regimes.add_argument(
        "--output-windows-presidents",
        type=Path,
        default=Path("data/derived/regimes/regime_windows_presidents.csv"),
        help="Presidents.csv-shaped windows CSV used for metric computation.",
    )
    regimes.add_argument(
        "--output-window-metrics",
        type=Path,
        default=Path("reports/regime_window_metrics_v1.csv"),
        help="Output CSV of metrics per regime window.",
    )
    regimes.add_argument(
        "--output-regime-summary",
        type=Path,
        default=Path("reports/regime_summary_v1.csv"),
        help="Output CSV of regime summaries grouped by (P,H,S).",
    )
    regimes.add_argument(
        "--output-party-summary",
        type=Path,
        default=Path("reports/regime_party_summary_v1.csv"),
        help="Output CSV of party summaries over regime windows (president party only).",
    )
    regimes.add_argument("--dotenv", type=Path, default=Path(".env"), help="Optional .env file to load into env vars.")

    compute = sub.add_parser("compute", help="Compute term-level metric table + party summaries.")
    compute.add_argument("--spec", type=Path, default=Path("spec/metrics_v1.yaml"), help="Metric registry spec YAML.")
    compute.add_argument("--attribution", type=Path, default=Path("spec/attribution_v1.yaml"), help="Attribution spec YAML.")
    compute.add_argument(
        "--president-source",
        choices=PRESIDENT_SOURCES,
        default="congress_legislators",
        help="If --presidents does not exist, generate it from this source.",
    )
    compute.add_argument(
        "--president-granularity",
        choices=PRESIDENT_GRANULARITY,
        default="tenure",
        help="If generating --presidents, choose tenure vs term windows.",
    )
    compute.add_argument(
        "--presidents",
        type=Path,
        default=Path("data/derived/presidents.csv"),
        help="Presidents terms CSV (generated by `rb presidents`).",
    )
    compute.add_argument("--output-terms", type=Path, default=Path("reports/term_metrics_v1.csv"), help="Output CSV (term-level).")
    compute.add_argument("--output-party", type=Path, default=Path("reports/party_summary_v1.csv"), help="Output CSV (party-level).")
    compute.add_argument("--dotenv", type=Path, default=Path(".env"), help="Optional .env file to load into env vars.")

    return p.parse_args()


def main() -> int:
    args = _parse_args()
    load_dotenv(args.dotenv, override=False)

    if args.cmd == "ingest":
        ingest_from_spec(
            spec_path=args.spec,
            refresh=bool(args.refresh),
            only_sources=set(args.sources) if args.sources else None,
            only_series=set(args.series) if args.series else None,
        )
        return 0

    if args.cmd == "presidents":
        ensure_presidents(
            refresh=bool(args.refresh),
            source=str(args.source),
            output_csv=args.output,
            granularity=str(args.granularity),
        )
        return 0

    if args.cmd == "congress":
        out = ensure_congress_control(refresh=bool(args.refresh))
        if Path(args.output) != out:
            # Copy to requested output path.
            Path(args.output).parent.mkdir(parents=True, exist_ok=True)
            Path(args.output).write_text(out.read_text(encoding="utf-8"), encoding="utf-8")
        return 0

    if args.cmd == "regimes":
        ensure_regime_pipeline(
            refresh=bool(args.refresh),
            spec_path=args.spec,
            attribution_path=args.attribution,
            presidents_csv=args.presidents,
            president_source=str(args.president_source),
            president_granularity=str(args.president_granularity),
            congress_csv=args.congress_control,
            output_windows_labels_csv=args.output_windows_labels,
            output_windows_presidents_csv=args.output_windows_presidents,
            output_window_metrics_csv=args.output_window_metrics,
            output_regime_summary_csv=args.output_regime_summary,
            output_party_summary_csv=args.output_party_summary,
        )
        return 0

    if args.cmd == "compute":
        if not args.presidents.exists():
            ensure_presidents(
                refresh=False,
                source=str(args.president_source),
                output_csv=args.presidents,
                granularity=str(args.president_granularity),
            )
        compute_term_metrics(
            spec_path=args.spec,
            attribution_path=args.attribution,
            presidents_csv=args.presidents,
            output_terms_csv=args.output_terms,
            output_party_csv=args.output_party,
        )
        return 0

    raise RuntimeError(f"unhandled cmd={args.cmd!r}")
